<div class="assistant-container">
  <button class="sidebar-toggle" (click)="toggleSidebar()">
    <mat-icon>menu</mat-icon>
  </button>
  
  <div class="sidebar-overlay" [class.active]="sidebarOpen" (click)="closeSidebar()"></div>
  
  <div class="chat-sidebar" [class.open]="sidebarOpen">
    <button class="new-chat-btn" (click)="clearCurrentChat()">
      <mat-icon>add_circle_outline</mat-icon>
      Nuova Chat
    </button>
    <div class="chats">
      @for (chat of chats(); track chat._id) {
        <div class="chat" 
             [class.selected]="selectedChatId === chat._id"
             (click)="loadChat(chat); closeSidebar()">
          <!-- Titolo normale (visibile quando non in modalitÃ  modifica) -->
          <p class="chat-title" *ngIf="!chat.editing">"{{chat.title}}"</p>
          
          <!-- Input per modifica (visibile solo quando in modalitÃ  modifica) -->
          <input
            *ngIf="chat.editing"
            class="chat-title-edit"
            type="text"
            [(ngModel)]="chat.editTitle"
            (blur)="saveEditedTitle(chat)"
            (keyup.enter)="saveEditedTitle(chat)"
            (keyup.escape)="cancelEdit(chat)"
            #titleInput
          />
          
          <div class="chat-actions">
            <button (click)="startEditChat(chat, $event); $event.stopPropagation()">
              <mat-icon>edit</mat-icon>
            </button>
            <button (click)="deleteChat(chat); $event.stopPropagation()">
              <mat-icon>delete_outline</mat-icon>
            </button>
          </div>
        </div>
      }
    </div>
  </div>
  
  <div class="chat-content">
    <div class="messages" #chatContent>
      @for (message of messages(); track message._id) {
        <div
          #messageElems
          class="message"
          *ngIf="message.role !== 'system'"
          [ngClass]="{
            'from-user': message.role === 'user',
            generating: message.generating
          }"
          ><p markdown [data]="message.content"> </p>
        </div>
      }
    </div>
    <div class="message-form" [class.generating]="generatingInProgress()">
      <form #form="ngForm" (ngSubmit)="sendMessage(form, form.value.message)">
        <textarea
          name="message"
          placeholder="Chiedi qualcosa..."
          ngModel
          required
          autofocus
          rows="1"
        ></textarea>
        <button type="submit" [disabled]="generatingInProgress() || form.invalid">
          <mat-icon>send</mat-icon>
        </button>
      </form>
    </div>
  </div>
</div>